SELECT f.flight_id, -- ID рейса
 f.scheduled_departure, -- Дата и время отправления
 f.scheduled_duration, -- Установленное время полета
 f.departure_city, -- Город отправления
 f.arrival_airport_name, -- Аэропорт прибытия
 f.arrival_city, -- Город прибытия
 a.model, -- Модель самолета
 a.range, -- Дальность полета самолета
 t1.passengers, -- Количество пассажиров на рейсе
 t2.max_passengers, -- Максималтное количество пассажиров
 t1.total_amount -- Сумма проданных билетов
FROM dst_project.flights_v f
LEFT JOIN -- Получаем модель самолета
 dst_project.aircrafts a ON a.aircraft_code = f.aircraft_code
LEFT JOIN -- Получаем информацию о проданных билетах

  (SELECT bp.flight_id,
          count(bp.seat_no) passengers,
          sum(b.total_amount) total_amount
   FROM dst_project.tickets t
   LEFT JOIN dst_project.bookings b ON t.book_ref = b.book_ref
   LEFT JOIN dst_project.boarding_passes bp ON bp.ticket_no = t.ticket_no
   GROUP BY bp.flight_id) t1 ON t1.flight_id = f.flight_id
LEFT JOIN -- Получаем информацию о максимальном количестве пассажиров для каждой модели самолета

  (SELECT s.aircraft_code,
          a.model,
          count(s.seat_no) max_passengers
   FROM dst_project.seats s
   LEFT JOIN dst_project.aircrafts a ON a.aircraft_code = s.aircraft_code
   GROUP BY s.aircraft_code,
            a.model) t2 ON t2.aircraft_code = f.aircraft_code
WHERE -- Оставляем информацию о состоявшихся зимних рейсах из Анапы
 f.departure_airport = 'AAQ'
  AND (date_trunc('month', f.scheduled_departure) in ('2017-01-01',
                                                      '2017-02-01',
                                                      '2017-12-01'))
  AND f.status not in ('Cancelled')
